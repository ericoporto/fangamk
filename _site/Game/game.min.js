function clone(e){var t=e instanceof Array?[]:{};for(i in e)"clone"!=i&&(t[i]=e[i]&&"object"==typeof e[i]?clone(e[i]):e[i]);return t}function removeA(e){for(var t,n,i=arguments,s=i.length;s>1&&e.length;)for(t=i[--s];-1!==(n=e.indexOf(t));)e.splice(n,1);return e}function menu(e,t,n){var i=[];t="undefined"==typeof t?null:t,n="undefined"==typeof n?!1:!0,this.items=e,this.noexit=n,this.parent=null,this.index=t,this.enabled=!1,this.selectedItem=null,this.wait=!1,this.isMenu=!0,this.updateOrder=function(){for(var e=0;e<Object.keys(this.items).length;e++){var t=Object.keys(this.items)[e];i[e]=[t,this.items[t].index]}i.sort(function(e,t){return e[1]-t[1]}),this.selectedItem=this.items[i[0][0]];for(var e=0;e<i.length;e++)0==e?(this.items[i[e][0]].previous=i[0][0],this.items[i[e][0]].next=i[e+1][0]):e==i.length-1?(this.items[i[e][0]].previous=i[e-1][0],this.items[i[e][0]].next=i[e][0]):(this.items[i[e][0]].previous=i[e-1][0],this.items[i[e][0]].next=i[e+1][0]),this.items[i[e][0]].itemy=32+32*e;null==this.selectedItem&&(this.selectedItem=this.items[Object.keys(this.items)[0]]),this.selectedItem.selected=!0},this.updateOrder(),this.maxItemStringSize=function(){for(var e=0,t=0;t<Object.keys(this.items).length;t++){var n=Object.keys(this.items)[t];e<n.length&&(e=n.length)}return e},this.itemsLength=Object.keys(e).length,this.exit=function(){this._counter=0,this.enabled=!1,HID.inputs.cancel.active=!1,engine.waitTime(200),null!=this.parent?(this.parent.wait=!1,this.parent.menuKeyWasPressed=32):engine.atomStack.push(engine.atomStack.push([function(){engine.atomStack=menus.holdAtomStack},""]),"")},this.activate=function(){this.enabled=!0,null!=this.parent?this.parent.wait=!0:(menus.holdAtomStack=engine.atomStack,engine.atomStack=new Array)},this._counter=0,this.menuKeyWasPressed=0,this.update=function(){if(this._counter<20&&(this._counter+=1),0==this.menuKeyWasPressed){if(!this.wait)if(HID.inputs.up.active)this.selectedItem.selected=!1,this.selectedItem=this.items[this.selectedItem.previous],this.selectedItem.selected=!0,HID.inputs.up.active=!1,this.menuKeyWasPressed=32;else if(HID.inputs.left.active);else if(HID.inputs.right.active);else if(HID.inputs.down.active)this.selectedItem.selected=!1,this.selectedItem=this.items[this.selectedItem.next],this.selectedItem.selected=!0,HID.inputs.down.active=!1,this.menuKeyWasPressed=32;else if(HID.inputs.accept.active){if(HID.inputs.accept.active=!1,"exit"==this.selectedItem.action)this.exit();else if("[object Array]"===Object.prototype.toString.call(this.selectedItem.action))for(var e=0;e<this.selectedItem.action.length;e++)"exit"==this.selectedItem.action[e]?this.exit():"goWait"==this.selectedItem.action[e]?engine.atomStack.push([function(){this.wait=!0},""]):"stopWait"==this.selectedItem.action[e]?engine.atomStack.push([function(){this.wait=!1},""]):this.selectedItem.action[e]();else"undefined"==typeof this.selectedItem.isMenu?this.selectedItem.action():(this.selectedItem.menuKeyWasPressed=32,this.selectedItem.action());this.menuKeyWasPressed=32}else HID.inputs.cancel.active&&this._counter>=20&&0==this.noexit&&(HID.inputs.cancel.active=!1,this.exit(),engine.waitTime(200),this.menuKeyWasPressed=32)}else this.menuKeyWasPressed-=4},this.action=this.activate,this.mdelete=function(){for(var e=0;e<menus.allMenus.length;e++)if(menus.allMenus[e]==this){menus.allMenus.splice(e,1);break}},menus.allMenus.push(this)}function charalist(){if("charas"in engine.currentLevel.Level){if(listofcharas=engine.currentLevel.Level.charas,""==listofcharas[0])return[];for(var e=listofcharas.length,t=[],n=0;e>n;n++){var i=listofcharas[n];t.push(new char(i[0],i[1],i[2]))}return t}return[]}function char(e,t,n){this.chara=resources.charas[e],this.nocolision=this.chara.properties.nocolision,this.charaset=resources.charasets[this.chara.charaset],this.facing="down",this.steps=0,this.waits=0,this.mapx=32*t,this.mapy=32*(n-1),this.movstack=clone(this.chara.movements),this.stopped=!1,this.mapwidth=engine.currentLevel.Level.colision.length,this.mapheight=engine.currentLevel.Level.colision[0].length-1,this.checkMapBoundaries=function(e,t,n,i){return engine.checkMapBoundaries(this,e,t,n,i)},this.facingPosition=function(e,t){return engine.facingPosition(this,e,t)},this.isFacingPlayer=function(){return engine.isCharFacingPlayer(this)},this.imediate=1==this.chara.actions.type[1],this.followPlayer=function(){this.facing=engine.charaLookToPlayer(this)},this.update=function(){if(!printer.isShown)if(0==this.steps&&0==this.waits&&0==this.stopped)if(this.movstack.length>0){var e=Math.floor(this.mapx/32),t=Math.floor(this.mapy/32)+1,n=this.movstack.shift();if("move"==n[0]){"follow"==n[1]?this.followPlayer():this.facing="random"==n[1]?engine.randomDirection():n[1];var i=this.facingPosition(e,t);if(this.imediate&&this.isFacingPlayer()){var s=Math.floor(player.mapx/32),a=Math.floor(player.mapy/32)+1;eventInChar(this,[0,1],[a-1,s])}this.checkMapBoundaries(e,t,this.mapwidth,this.mapheight)&&0==engine.currentLevel.Level.colision[i[0]][i[1]]?this.steps=32:this.waits=16}"face"==n[0]&&("follow"==n[1]?this.followPlayer():this.facing="random"==n[1]?engine.randomDirection():n[1],this.waits=16)}else this.chara.movements!=[]&&(this.movstack=clone(this.chara.movements));else this.steps>0&&0==this.waits&&0==this.stopped?engine.charWalkSteps(this,1):this.waits>0&&0==this.stopped&&(this.waits-=2)}}function compareChars(e,t){return e.mapy==t.mapy?e.mapx<t.mapx?-1:e.mapx>t.mapx?1:0:e.mapy<t.mapy?-1:1}function wordWrap(e,t,n,i){if(n=n||"\n",t=t||75,i=i||!1,!e)return e;var s=".{1,"+t+"}(\\s|$)"+(i?"|.{"+t+"}|.+$":"|\\S+?(\\s|$)");return e.match(RegExp(s,"g")).join(n)}getkey0=function(e,t){return t in e?e[t]:0},window.mobilecheck=function(){return window.forceMobile||window.__mobilecheck()},jsonLevelGet=function(e){var t=new XMLHttpRequest;t.open("get",e,!1),t.send();var n=t.responseText;return JSON.parse(n)},window.__mobilecheck=function(){var e=!1;return function(t){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e},window.isFirefox=function(){var e=!1;return function(t){/firefox/i.test(t)&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e},items={},items.setup=function(e){this.inventory={},this.allitems={},this.allitems=e,this.defaultItem=function(){return{equipable:!1,equiped:!1,usable:!1,unique:!1,effect:null,statMod:null,description:!1,name:null,icon:null,category:null,action:null,quantity:1}},this.addItem=function(e){if(e in this.inventory)this.inventory[e].unique||(this.inventory[e].quantity+=1);else if(e in this.allitems){var t=this.defaultItem();for(var n in this.allitems[e])t[n]=this.allitems[e][n];null==t.name&&(t.name=e),this.inventory[e]=t}this.menuUpdate(engine.mapMenu)},this.subtractItem=function(e){this.inventory[e].quantity-=1,this.inventory[e].quantity<=0&&this.deleteItem(e),this.menuUpdate(engine.mapMenu)},this.deleteItem=function(e){delete this.inventory[e]},this.effect={},this.pts=function(e){var t=getkey0(this.inventory[e].effect,"basep"),n=getkey0(this.inventory[e].effect,"plus"),i=getkey0(this.inventory[e].effect,"atr");return Math.max(battle.diceroll(t+i)+n,0)},this.effect.hpup=function(e,t){e.hp=Math.min(e.hp+t,e.hpmax)},this.useItem=function(e){if(null==this.inventory[e].action){var t=this.pts(e),n=[];n.push(battle.heroes[player.party[0]]);for(var i=this.inventory[e].effect.effect,s=0;s<n.length;s++)for(var a=0;a<i.length;a++)this.effect[i[a]](n[s],t);this.subtractItem(e)}},this.equipItem=function(e){if(1==player.party.length){var t=battle.heroes[player.party[0]],n=player.party[0],i=this.inventory[e];t.equiped[i.category]||(i.equiped=n,t.equiped[i.category]=e,i.statMod&&("undefined"!=typeof i.statMod.st&&(t.mod.st+=i.statMod.st),"undefined"!=typeof i.statMod.dx&&(t.mod.dx+=i.statMod.dx),"undefined"!=typeof i.statMod.iq&&(t.mod.iq+=i.statMod.iq)))}this.menuUpdate(engine.mapMenu)},this.unequipItem=function(e){if(1==player.party.length){var t=battle.heroes[player.party[0]],n=player.party[0],i=this.inventory[e];t.equiped[i.category]==e&&i.equiped==n?(i.statMod&&("undefined"!=typeof i.statMod.st&&(t.mod.st-=i.statMod.st),"undefined"!=typeof i.statMod.dx&&(t.mod.dx-=i.statMod.dx),"undefined"!=typeof i.statMod.iq&&(t.mod.iq-=i.statMod.iq)),i.equiped=!1,t.equiped[i.category]=!1):console.log("tried to unequip item, but it wasn't equiped!")}this.menuUpdate(engine.mapMenu)},this.lookItem=function(e){this.inventory[e].description&&actions.showText(this.inventory[e].description)},this.dropItem=function(e){this.subtractItem(e)},this.getMenu=function(){return this.menu},this.menuUpdate=function(e){if("undefined"!=typeof this.menu){var t=this.menu.enabled;this.menu.enabled=!1,this.menu.mdelete()}else{var t=!1;this.menu={}}var n={},i=0;for(var s in this.inventory){var a=this.inventory[s].name,r=0,o={};this.inventory[s].equipable&&(this.inventory[s].equiped?(o.unequip={},o.unequip.index=r,o.unequip.action=[function(){items.unequipItem(s)},"exit"]):(o.equip={},o.equip.index=r,o.equip.action=[function(){items.equipItem(s)},"exit"]),r++),this.inventory[s].usable&&(o.use={},o.use.index=r,o.use.action=[function(){items.useItem(s)},"exit"],r++),this.inventory[s].description&&(o.look={},o.look.index=r,o.look.action=[function(){items.lookItem(s)},"exit"],r++),this.inventory[s].unique||(o.drop={},o.drop.index=r,o.drop.action=[function(){items.dropItem(s)},"exit"],r++),o.back={},o.back.action="exit",o.back.index=r++,n[a]=new menu(o,i),i++}0==i&&(n.empty={},n.empty.action=function(){},n.empty.index=i,i++),n.back={},n.back.action="exit",n.back.index=i,i++,this.menu=new menu(n,0),"undefined"==typeof e?menus.setParent(this.menu):(e.items.items=this.menu,e.updateOrder(),menus.setParent(e)),menus.setAllDrawables(),this.menu.enabled=t}};var menus={allMenus:[],isAnyMenuEnabled:function(){var e=!1;for(var t in this.allMenus)this.allMenus[t].enabled&&(e=!0);return e},updateMenuEnabled:function(){var e=null;for(var t in this.allMenus)this.allMenus[t].enabled&&this.allMenus[t].update();return e},setParent:function(e){if(void 0!=e.items)for(n in e.items)e.items[n].parent=e,this.setParent(e.items[n])},setDrawables:function(e){null==e.parent?(e.drawx=16,e.drawy=16,e.height=32*e.itemsLength+32,e.width=13*e.maxItemStringSize()+32):(e.drawx=e.parent.drawx+e.parent.width,e.drawy=e.parent.drawy,e.height=32*e.itemsLength+32,e.width=13*e.maxItemStringSize()+32)},setAllDrawables:function(){for(var e in this.allMenus)for(var t in this.allMenus)this.setDrawables(this.allMenus[t])}},chars=[],engine={};window.ondevicemotion=function(e){player.running=e.accelerationIncludingGravity.y>4?!1:!0},feedbackEng={once:!1,timer:null,vibrationOn:!1,soundOn:!1,sounds:{stop:"audioStop",text:"audioText",word:"audioWord"},vibration:{stop:[10,5,10],text:[25],word:[10]},loadedSounds:{},vibrate:null,setup:function(){navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate,navigator.vibrate&&(this.vibrationOn=!0),window.isFirefox()&&(this.soundOn=!0);for(var e in this.sounds)this.loadedSounds[e]=document.getElementById(this.sounds[e])},play:function(e){0==this.once&&(this.vibrationOn&&navigator.vibrate(this.vibration[e]),this.soundOn&&this.loadedSounds[e].cloneNode(!0).play())},turnOnceOffTime:function(){this.timer=setTimeout(function(){feedbackEng.once=!1},100)}},engine.checkMapBoundaries=function(e,t,n,i,s){return"up"==e.facing?n>0:"left"==e.facing?t>0:"right"==e.facing?i>t:"down"==e.facing?s>n:True},engine.facingPosition=function(e,t,n){var i=e.facing;return"up"==i?[n-1,t]:"left"==i?[n,t-1]:"right"==i?[n,t+1]:[n+1,t]},engine.charWalkSteps=function(e,t){e.steps-=t,"up"==e.facing?e.mapy-=t:"left"==e.facing?e.mapx-=t:"right"==e.facing?e.mapx+=t:(e.facing="down")&&(e.mapy+=t)},engine.charaLookToPlayer=function(e){var t=Math.floor(player.mapx/32),n=Math.floor(player.mapy/32)+1,i=Math.floor(e.mapx/32),s=Math.floor(e.mapy/32)+1,a=i-t,r=s-n;return 0==a&&0>r?"down":0==a&&r>0?"up":0>a?"right":"left"},engine.randomDirection=function(){var e=["down","up","right","left","down"];return e[Math.floor(4*Math.random())]},engine.isCharFacingPlayer=function(e){var t=Math.floor(e.mapx/32),n=Math.floor(e.mapy/32)+1,i=Math.floor(player.mapx/32),s=Math.floor(player.mapy/32)+1;return t-i==1&&s-n==0&&"left"==e.facing?!0:t-i==-1&&s-n==0&&"right"==e.facing?!0:t-i==0&&s-n==1&&"down"==e.facing?!0:t-i==0&&s-n==-1&&"up"==e.facing?!0:!1};var player={};player.setup=function(){player.charaset=resources.playerCharaset,player.mapx=init.Player.initPosX,player.mapy=init.Player.initPosY,player.facing=init.Player.facing,player.party=init.Player.party,player.steps=0,player.waits=0,player.running=!1,player.checkMapBoundaries=function(e,t,n,i){return engine.checkMapBoundaries(player,e,t,n,i)},player.update=function(){if(!printer.isShown){var e=Math.floor(player.mapx/32),t=Math.floor(player.mapy/32)+1,n=engine.currentLevel.Level.colision.length,i=engine.currentLevel.Level.colision[0].length-1;if(0==player.steps&&0==this.waits){var s=engine.dirKeyActive();if(s){player.facing=s;var a=player.facingPosition();if(player.checkMapBoundaries(e,t,n,i)){var r=engine.playerFaceChar();0!=engine.currentLevel.Level.colision[a[0]][a[1]]||r.nocolision?(feedbackEng.play("stop"),HID.inputs[s].active=!1):(player.steps=32,r&&eventInChar(r,[0,1],[t-1,e]),0!=engine.currentLevel.Level.events[a[0]][a[1]]&&(eventInMap(engine.currentLevel.Level,engine.currentLevel.Level.events[a[0]][a[1]],[0,1],a),HID.inputs.accept.active=!1,engine.waitTime(400)))}else feedbackEng.play("stop"),HID.inputs[s].active=!1}else if(HID.inputs.accept.active){var r=engine.playerFaceChar();if(r)eventInChar(r,[1,0],[t-1,e])?(HID.inputs.accept.active=!1,engine.waitTime(400)):player.waits=16;else if(t-1>0&&e-1>0&&e+1<engine.currentLevel.Level.events.length&&e+1<engine.currentLevel.Level.events.length){var o=player.facingPosition();0!=engine.currentLevel.Level.events[o[0]][o[1]]&&(eventInMap(engine.currentLevel.Level,engine.currentLevel.Level.events[o[0]][o[1]],[1,0],o),HID.inputs.accept.active=!1,engine.waitTime(400))}}else HID.inputs.cancel.active&&(HID.inputs.cancel.active=!1,engine.mapMenu.activate())}else 0==player.waits?(engine.charWalkSteps(player,2),player.running&&0!=player.steps&&engine.charWalkSteps(player,2)):player.waits-=1}}},engine.resetBlocks=function(){actions.blockCounter=0,actions.blockStack=new Array,actions.blockStack.push(actions.blockCounter.valueOf())},engine.setup=function(){engine.currentLevel=null,engine.levels=null,engine.paused=!1,engine.frameCount=0,engine.timer=null,engine.waitKey=!1,engine.waitTimeSwitch=!1,engine.minimumWait=!1,engine.atomStack=new Array,engine.st={},engine.st.vars={},engine.resetBlocks(),engine.state="startScreen",engine.questionBoxUndef=-1,engine.questionBoxAnswer=engine.questionBoxUndef,engine.menuSetup()},engine.menuSetup=function(){items.setup(resources.items),items.menuUpdate(),engine.mapMenu=new menu({items:items.menu,status:{action:function(){engine.mapMenu.wait=!0,actions.showStatus("hero"),engine.atomStack.push([function(){engine.mapMenu.wait=!1},null])},index:1},test:new menu({test2:new menu({yes:{action:["goWait",function(){actions.showText("this is a yes!")},"stopWait","exit"],index:0,icon:"icon1"},no:{action:[function(){actions.showText("this is a no!")},"exit"],index:1,icon:"icon0"}},0),yes1:{action:[function(){actions.showText("this is a yes1!")},"exit"],index:1},no1:{action:[function(){actions.showText("this is a no1!")},"exit"],index:2}},2),config:new menu({showFPS:new menu({yes:{action:[function(){debug.FPS.show=!0},"exit"],index:0},no:{action:[function(){debug.FPS.show=!1},"exit"],index:1}},0),back:{action:"exit",index:2}},3),exit:{action:"exit",index:4}}),menus.setParent(engine.mapMenu)},engine.playerFaceChar=function(){for(var e=chars.length,t=0;e>t;t++){var n=chars[t];if(player!=n){var i=Math.floor(player.mapx/32),s=Math.floor(player.mapy/32)+1,a=Math.floor(n.mapx/32),r=Math.floor(n.mapy/32)+1;if(i-a==1&&r-s==0&&"left"==player.facing)return n;if(i-a==-1&&r-s==0&&"right"==player.facing)return n;if(i-a==0&&r-s==1&&"down"==player.facing)return n;if(i-a==0&&r-s==-1&&"up"==player.facing)return n}}return!1},engine.updateChars=function(){for(var e=chars.length,t=0;e>t;t++){var n=chars[t];n.update()}},engine.testWaitForKey=function(){HID.inputs.accept.active?(engine.waitKey=!1,HID.inputs.accept.active=!1,engine.minimumWait=!1):HID.inputs.cancel.active&&(engine.waitKey=!1,HID.inputs.cancel.active=!1,engine.minimumWait=!1)},engine.waitForKey=function(e){engine.waitKey=e,engine.minimumWait=!1,setTimeout(function(){engine.minimumWait=!0},300)},engine.waitTime=function(e){engine.waitTimeSwitch=!0,engine.minimumWait=!1,setTimeout(function(){engine.waitTimeSwitch=!1},e)},engine.dirKeyActive=function(){return HID.inputs.up.active?"up":HID.inputs.down.active?"down":HID.inputs.left.active?"left":HID.inputs.right.active?"right":!1},engine.loop=function(){try{this.paused||(HID.processGamepad(),engine.waitKey||engine.waitTimeSwitch?this.minimumWait&&this.testWaitForKey():menus.isAnyMenuEnabled()?(menus.updateMenuEnabled(),engine.runatomStack()):("map"==engine.state?engine.updateChars():"startScreen"==engine.state?title.startScreen():"battle"==engine.state&&battle.update(),engine.runatomStack())),HID.clearInputs(),engine.timer=setTimeout("engine.loop()",1e3/46)}catch(e){alert("engine loop error: "+e)}},engine.runatomStack=function(){if(engine.atomStack.length>0)for(;engine.atomStack.length>0&&(eventToRun=engine.atomStack.shift(),"block"!=eventToRun[0]);)eventToRun[0](eventToRun[1],eventToRun[2])},evalCondition=function(param){var value=eval(param[0]);return value},eventInChar=function(e,t,n){if(e.chara.actions.type[0]==t[0]&&e.chara.actions.type[1]==t[1]){e.charwasfacingfirst=e.facing,e.waits=16;var i=player.charaFacingTo(e);i&&(e.facing=i),e.stopped=!0,engine.resetBlocks();var s,a;for(s=0;s<e.chara.actions.list.length;s++)a=e.chara.actions.list[s],translateActions(a[0],a[1],n,e);return engine.atomStack.push([function(){e.stopped=!1,e.facing=e.charwasfacingfirst},""]),!0}return!1},player.charaFacingTo=function(e){var t=Math.floor(player.mapx/32),n=Math.floor(player.mapy/32)+1,i=Math.floor(e.mapx/32),s=Math.floor(e.mapy/32)+1,a=i-t,r=s-n;return 0==a&&0>r?"down":0==a&&r>0?"up":0>a&&0==r?"right":"left"},player.facingPosition=function(){var e=Math.floor(player.mapx/32),t=Math.floor(player.mapy/32)+1;return engine.facingPosition(player,e,t)},eventInMap=function(e,t,n,i){if(engine.resetBlocks(),e.eventsType[t.toString()][0]==n[0]&&e.eventsType[t.toString()][1]==n[1]){var s,a;for(s=0;s<e.eventsActions[t.toString()].length;s++)a=e.eventsActions[t.toString()][s],translateActions(a[0],a[1],i)}},engine.addItem=function(e){for(var t=0;t<e.length;t++)items.addItem(e[t])},engine.battle=function(e){battle.start(e)},engine.changeState=function(e){engine.state=e[0]},engine.teleport=function(e){engine.state="map",engine.currentLevel=resources.levels[e[2]],player.mapx=32*parseInt(e[0],10),player.mapy=32*(parseInt(e[1],10)-1),player.steps=32,player.facing="down",HID.cleanInputs(),HID.clearInputs(),chars=new charalist,chars.push(player)},engine.changeTile=function(e){if(null==e[6]||"this"==e[6])var t=engine.currentLevel;else var t=resources.levels[e[6]];-1!=e[2]&&(t.Level.colision[e[4]][e[5]]=e[2]),-1!=e[3]&&(t.Level.events[e[4]][e[5]]=e[3]),t.Level[e[1]][e[4]][e[5]]=e[0]},engine.evalNum=function(e){var t=e.slice(0);return isNaN(t)?0==t.indexOf("var:")?engine.st.vars[t.split("var:")[1]]:0==t.indexOf("ans:")?"num"==t.split("ans:")[1]?engine.questionBoxAnswer:engine.questionBoxAnswerStr:0==t.indexOf("lastbattle:")?battle.lastresult:t:+t},engine.IF=function(e,t){if(engine.testVar(e))for(var n=!1,i=0;i<engine.atomStack.length;i++){if(engine.atomStack[i][0]==engine.ELSE&&engine.atomStack[i][2]==t&&(n=!0),engine.atomStack[i][0]==engine.END&&engine.atomStack[i][2]==t)return;n&&(engine.atomStack.splice(i,1),i--)}else for(var s=[0,0,0];engine.atomStack.length>0&&s[0]!=engine.END&&s[0]!=engine.ELSE||s[2]!=t;)s=engine.atomStack.shift()},engine.END=function(){},engine.ELSE=function(){},engine.setVar=function(e){engine.st.vars[e[0]]=engine.evalNum(e[1])},engine.varPlusOne=function(e){isNaN(engine.st.vars[e[0]])&&(engine.st.vars[e[0]]=0),engine.st.vars[e[0]]++},engine.testVar=function(e){var t=engine.evalNum(e[0]);if("true"==t)return!0;if("false"==t)return!1;var n=e[1],i=engine.evalNum(e[2]),s={">":function(e,t){return e>t},bigger:function(e,t){return e>t},"<":function(e,t){return t>e},smaller:function(e,t){return t>e},">=":function(e,t){return e>=t},"<=":function(e,t){return t>=e},"==":function(e,t){return e==t},equal:function(e,t){return e==t},"=":function(e,t){return e==t}};return s[n](t,i)},engine.showPicture=function(e){var t={};t.image=e[0],t.position=[e[1],e[2]],screen.pictureStack.push(t)},engine.stopPicture=function(){screen.clearPicture()},engine.charAutoDelete=function(e,t){for(var n=-2,i=0;i<chars.length;i++)if(chars[i]==t){n=i;break}chars[n]!=engine.player&&chars.splice(n,1)},engine.questionBox=function(e){var t={};engine.questionBoxAnswer=engine.questionBoxUndef,"undefined"!=typeof engine.questionBoxMenu&&engine.questionBoxMenu.mdelete();for(var n=0;n<e.length;n++)!function(n){t[e[n]]={action:[function(){engine.questionBoxAnswer=n,engine.questionBoxAnswerStr=e[n]},"exit"],index:n}}(n);engine.questionBoxMenu=new menu(t,void 0,!0),menus.setParent(engine.questionBoxMenu),menus.setAllDrawables(),engine.questionBoxMenu.activate()},engine.proceedBattleTurn=function(){battle.waitherodecision=!1},translateActions=function(e,t,n,i){actions[e](t,n,i)},engine.update=function(e){engine.frameCount=e};var actions={};lastBlock=function(){var e=0,t=actions.blockStack.slice(0);return t.length>1?e=t[t.length-1]:1==t.length&&(e=t[0]),e},actions.charAutoDelete=function(e,t,n){var i=e.split(";");engine.atomStack.push([engine.charAutoDelete,i,n])},actions.questionBox=function(e){var t=e.split(";");engine.questionBoxAnswer=engine.questionBoxUndef,engine.atomStack.push([engine.questionBox,t]),engine.atomStack.push(["block",null]),engine.atomStack.push(["block",null])},actions.stopPicture=function(){engine.atomStack.push([engine.stopPicture,""])},actions.showPicture=function(e){var t=e.split(";");engine.atomStack.push([engine.showPicture,t])},actions.changeState=function(e){var t=e.split(";");engine.atomStack.push([engine.changeState,t])},actions.IF=function(e){var t=e.split(";");actions.blockCounter++,actions.blockStack.push(actions.blockCounter.valueOf()),engine.atomStack.push([engine.IF,t,lastBlock()])},actions.ELSE=function(){engine.atomStack.push([engine.ELSE,"",lastBlock()])},actions.END=function(){engine.atomStack.push([engine.END,"",lastBlock()]);actions.blockStack.pop()},actions.preText=function(e){e.slice(0);return e.slice(0).replace(/(var:)([a-zA-Z0-9]+)/g,function(e){return engine.evalNum(e)})},actions.showStatus=function(e){var t=e.split(";"),n=battle.heroes[t[0]];engine.atomStack.push([function(e){battle.herotoshowstatus=e},n]),engine.atomStack.push([engine.waitForKey,!0]),engine.atomStack.push(["block",null]),engine.atomStack.push([function(){battle.herotoshowstatus=!1,engine.waitTime(400)},""])},actions.showText=function(e){text=actions.preText(e),engine.atomStack.push([printer.showText,text]);var t,n=printer.textLines(text);for(t=0;n>t;t+=2)engine.atomStack.push([engine.waitForKey,!0]),engine.atomStack.push(["block",null]),engine.atomStack.push([function(){printer.nextLine(),engine.waitTime(400)},""])},actions.teleport=function(e){var t=e.split(";");engine.atomStack.push([function(){screen.paused=!0},""]),engine.atomStack.push([engine.teleport,t]),engine.atomStack.push([function(){screen.paused=!1},""])},actions.changeTile=function(e,t){var n,i={keep:-1,noColision:0,collidable:1},s=e.split(";"),a=s[0],r=s[1],o=i[s[2]];n="keep"==s[3]?-1:"remove"==s[3]?0:parseInt(s[3],10);var c,l,h,u=n;"current"==s[4]?(l=parseInt(t[0],10),c=t[1],h=null):(c=s[4],l=s[5],h=s[6]),engine.atomStack.push([engine.changeTile,[a,r,o,u,l,c,h]])},actions.fadeIn=function(e){var t=e.split(";");engine.atomStack.push([screen.effects.fadeIn,t]);for(var n=0;8>n;n++)engine.atomStack.push(["block",null])},actions.fadeOut=function(e){var t=e.split(";");engine.atomStack.push([screen.effects.fadeOut,t]);for(var n=0;8>n;n++)engine.atomStack.push(["block",null])},actions.setVar=function(e){var t=e.split(";");engine.atomStack.push([engine.setVar,t])},actions.varPlusOne=function(e){var t=e.split(";");engine.atomStack.push([engine.varPlusOne,t])},actions.testVar=function(e){var t=e.split(";");engine.atomStack.push([engine.testVar,t])},actions.noEffect=function(){engine.atomStack.push([screen.effects.noEffect,""])},actions.battle=function(e){var t=e.split(";");actions.fadeOut("tension1;keepEffect"),dist.setup(screen.canvas,"bgimg1",1),actions.changeState("battle"),engine.atomStack.push([engine.battle,t])},actions.addItem=function(e){var t=e.split(";");engine.atomStack.push([engine.addItem,t])},actions.proceedBattleTurn=function(){battle.herodecision="",engine.questionBoxAnswer=engine.questionBoxUndef,engine.atomStack.push([engine.proceedBattleTurn,[""]])};var camera={};camera.x=0,camera.y=0,camera.finex=0,camera.finey=0,camera.setupMap=function(e){this.maxWorldWidth=e.Level.layer1[0].length,this.maxWorldHeight=e.Level.layer1.length},camera.setupCanvas=function(){this.yerror=1-screen.GHEIGHT/32%2,this.width=Math.floor(screen.GWIDTH/32)+1,this.height=Math.floor(screen.GHEIGHT/32)+1,this.halfWidth=Math.floor(this.width/2),this.halfHeight=Math.floor(this.height/2)},camera.panToChara=function(e){charatilex=Math.floor(e.mapx/32),charatiley=Math.floor(e.mapy/32)+1,charatilex>this.halfWidth&&charatilex<this.maxWorldWidth-this.halfWidth?(this.x=charatilex,this.finex=e.mapx%32):charatilex==this.halfWidth?(this.x=this.halfWidth,this.finex=e.mapx%32):charatilex<this.halfWidth?this.x=this.halfWidth:charatilex==this.maxWorldWidth-this.halfWidth?(this.x=this.maxWorldWidth-this.halfWidth,this.finex=e.mapx%32):this.x=this.maxWorldWidth-this.halfWidth,charatiley>this.halfHeight&&charatiley<this.maxWorldHeight-this.halfHeight?(this.y=charatiley,this.finey=e.mapy%32):charatiley==this.halfHeight?(this.y=this.halfHeight,this.finey=e.mapy%32):charatiley<this.halfHeight?this.y=this.halfHeight:charatiley==this.maxWorldHeight-this.halfHeight-this.yerror?(this.y=this.maxWorldHeight-this.halfHeight-this.yerror,this.finey=e.mapy%32):this.y=this.maxWorldHeight-this.halfHeight-this.yerror,this.x-=this.halfWidth,this.y-=this.halfHeight},camera.drawMapLayer=function(e,t){var n,i,s=Math.floor(screen.frameCount/8)%4,a=0,r=0,o=0,c=0;for(this.panToChara(player),initX=Math.max(0,this.x),initY=Math.max(0,this.y),EndX=Math.min(this.maxWorldWidth,this.x+this.width),EndY=Math.min(this.maxWorldHeight,this.y+this.height),a=initX,o=0;a<EndX;a++,o++)for(r=initY,c=0;r<EndY;r++,c++)i=e.Level[t][r][a],n=e.Level.tiles[i],e.Level.tilesAnimated[i.toString()]&&(n=e.Level.tilesAnimated[i.toString()][s]),n&&screen.drawTile(resources.tileset,n,[32*o-this.finex,32*c-this.finey])},camera.drawChar=function(e){charaAnimation=e.steps?e.charaset.walking[e.facing]:e.charaset.standing[e.facing];var t=Math.floor(screen.frameCount/4)%charaAnimation.length,n=0,i=0;n=e.mapx-(32*this.x+this.finex),i=e.mapy-(32*this.y+this.finey),screen.drawChara(resources.charasetimg,charaAnimation,t,[n,i])},printBox={},printBox.show=function(){screen.printBox.targetFrame=0,screen.printBox.anim="fadeIn"},printBox.isShown=function(){return"box"==screen.printBox.anim?!0:!1},printBox.close=function(){screen.printBox.targetFrame=screen.printBox.frameMax,screen.printBox.anim="fadeOut"};var screen={};screen.paused=!1,screen.WIDTH=416,screen.HEIGHT=704,screen.GWIDTH=416,screen.GHEIGHT=416,screen.GSTARTX=0,screen.GSTARTY=0,screen.RATIO=null,screen.currentWidth=null,screen.currentHeight=null,screen.canvas=null,screen.ctx=null,screen.frameCount=0,screen.timer=null,screen.engine=null,screen.mobile=!1,screen.setEngine=function(e){this.engine=e},screen.drawChara=function(e,t,n,i){i[0]<this.GSTARTX-32||i[0]>this.GWIDTH+32||i[1]<this.GSTARTY-64||i[1]>this.GHEIGHT+64||screen.ctx.drawImage(e,32*t[n][0],64*t[n][1],32,64,this.GSTARTX+i[0],this.GSTARTY+i[1],32,64)},screen.drawTile=function(e,t,n){screen.ctx.drawImage(e,32*t[0],32*t[1],32,32,this.GSTARTX+n[0],this.GSTARTY+n[1],32,32)},screen.drawImage=function(e,t){screen.ctx.drawImage(e,this.GSTARTX+t[0],this.GSTARTY+t[1])},screen.drawFace=function(e,t,n,i){i="undefined"==typeof i?2:i,screen.ctx.drawImage(e,64*t[0],64*t[1],64,64,this.GSTARTX+n[0],this.GSTARTY+n[1],64*i,64*i)},screen.flashMonster=function(e,t){e.flashcolor=t,e.flash=10},screen.shakeMonster=function(e){e.shake=10},screen.drawMonster=function(e,t){var n=screen.ctx.globalAlpha,i=0,s=0;e.dead||(e.selected&&0==e.flash&&screen.flashMonster(e,"#111111"),e.shake>0&&(e.shake--,i=4*Math.floor(8*Math.random()),s=4*Math.floor(8*Math.random())),e.flash>0&&(screen.ctx.drawImage(screen.flashColor(resources.monsterimg,e.flashcolor),64*e.monsterImg[0],64*e.monsterImg[1],64,64,this.GSTARTX+t[0]+i,this.GSTARTY+t[1]+s,128,128),screen.ctx.globalAlpha=1*e.flash/10,e.flash--),screen.ctx.drawImage(resources.monsterimg,64*e.monsterImg[0],64*e.monsterImg[1],64,64,this.GSTARTX+t[0]+i,this.GSTARTY+t[1]+s,128,128),screen.ctx.globalAlpha=n,screen.ctx.fillStyle="#ffffff",screen.ctx.fillText("hp:"+e.hp,screen.GSTARTX+t[0],screen.GSTARTY+t[1]-32),screen.ctx.fillText(" /"+e.hpmax,screen.GSTARTX+t[0],screen.GSTARTY+t[1]-8))},screen.flashColor=function(e,t){var n=document.createElement("canvas");n.width=e.width,n.height=e.height;var i=n.getContext("2d");return i.fillStyle=t,i.fillRect(0,0,n.width,n.height),i.globalCompositeOperation="destination-atop",i.drawImage(e,0,0),n},screen.init=function(){window.addEventListener("resize",screen.resize,!1),window.addEventListener("orientationchange",screen.resize,!1),this.RATIO=this.WIDTH/this.HEIGHT,this.mobile=window.mobilecheck(),this.currentWidth=this.WIDTH,this.currentHeight=this.HEIGHT,this.canvas=document.getElementsByTagName("canvas")[0],this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.ctx=this.canvas.getContext("2d"),this.ctx.font="32px INFO56",this.ORIGINALGSTARTX=this.GSTARTX,this.ORIGINALGSTARTY=this.GSTARTY,this.resize(),this.pictureStack=new Array,this.ua=navigator.userAgent.toLowerCase(),this.android=this.ua.indexOf("android")>-1?!0:!1,this.ios=this.ua.indexOf("iphone")>-1||this.ua.indexOf("ipad")>-1?!0:!1,window.addEventListener("load",screen.init,!1),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];
window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var n=(new Date).getTime(),i=Math.max(0,16-(n-e)),s=window.setTimeout(function(){t(n+i)},i);return e=n+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),screen.requestAnimationFrame=window.requestAnimationFrame,window.addEventListener("click",function(){if("startScreen"==engine.state){var e=document.documentElement,t=e.requestFullScreen||e.webkitRequestFullscreen||e.mozRequestFullScreen;t.call(e),window.setTimeout(function(){screen.resize(),console.log("should had resized!")},1500)}})},screen.resize=function(){this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,screen.mobile?(this.currentHeight=window.innerHeight,this.currentWidth=this.currentHeight*this.RATIO):(this.GHEIGHT=256,this.currentHeight=window.innerHeight*this.HEIGHT/this.GHEIGHT,this.currentWidth=this.currentHeight*this.RATIO),(this.android||this.ios)&&(document.body.style.height=window.innerHeight+50+"px"),this.canvas.style.width=this.currentWidth+"px",this.canvas.style.height=this.currentHeight+"px",window.setTimeout(function(){window.scrollTo(0,1)},1)},screen.drawButton=function(e){this.ctx.fillStyle=e.active?"#ff9900":e.color,this.ctx.fillRect(e.mapX,e.mapY+this.GHEIGHT,96,96),this.ctx.fillStyle="#FFFFFF",this.ctx.fillText(e.letter,e.mapX+32,e.mapY+this.GHEIGHT+64)},screen.drawHID=function(){this.ctx.fillStyle="#221F1B",this.ctx.fillRect(0,this.GHEIGHT,this.GWIDTH,this.HEIGHT-this.GHEIGHT);var e;for(var t in HID.inputs)e=HID.inputs[t],screen.drawButton(e)},screen.clearAll=function(){this.ctx.fillRect(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT)},screen.printBox={setup:function(e){this.Width=screen.GWIDTH,this.Height=96,this.X=0,this.Y=screen.GHEIGHT-this.Height,this.imgPrintSet=e,this.aSizex=[32,64,128,this.Width,this.Width],this.aSizey=[32,32,48,48,this.Height],this.anim="none",this.frameMax=this.aSizex.length-1,this.targetFrame=this.frameMax},printSet:{background:{x:0,y:0,sizex:64,sizey:64},topLeftBox:{x:64,y:0,sizex:16,sizey:16},topRightBox:{x:112,y:0,sizex:16,sizey:16},bottomLeftBox:{x:64,y:48,sizex:16,sizey:16},bottomRightBox:{x:112,y:48,sizex:16,sizey:16},LeftBox:{x:64,y:16,sizex:16,sizey:32},RightBox:{x:112,y:16,sizex:16,sizey:32},TopBox:{x:80,y:0,sizex:32,sizey:16},BottomBox:{x:80,y:48,sizex:32,sizey:16},acceptUp:{x:0,y:64,sizex:16,sizey:16},acceptDown:{x:16,y:64,sizex:16,sizey:16},icon0:{x:0,y:96,sizex:64,sizey:64},icon1:{x:64,y:96,sizex:64,sizey:64}},drawButtonAccept:function(){var e=Math.floor(screen.frameCount/4)%2;if(0==e)var t=this.printSet.acceptUp;else var t=this.printSet.acceptDown;screen.ctx.drawImage(imgPrintSet,t.x,t.y,t.sizex,t.sizey,screen.GSTARTX+screen.GWIDTH-32,screen.GSTARTY+screen.GHEIGHT-32,t.sizex,t.sizey)},drawElement:function(e,t,n,i,s,a,r){r="undefined"==typeof r?0:r,screen.ctx.drawImage(a,e.x+64*r,e.y,e.sizex,e.sizey,screen.GSTARTX+t,screen.GSTARTY+n,i,s)},drawBoxAnimation:function(){if("none"!=this.anim){if("box"==this.anim)this.targetFrame=this.frameMax;else if("fadeIn"==this.anim)this.targetFrame<this.frameMax?this.targetFrame++:(this.anim="box",this.targetFrame=this.frameMax);else if("fadeOut"==this.anim){if(!(this.targetFrame>0))return void(this.anim="none");this.targetFrame--}screen.printBox.drawBox(Math.floor(screen.printBox.X+screen.printBox.Width/2-this.aSizex[this.targetFrame]/2),Math.floor(screen.printBox.Y+screen.printBox.Height/2-this.aSizey[this.targetFrame]/2),this.aSizex[this.targetFrame],this.aSizey[this.targetFrame]),"box"==this.anim&&this.drawButtonAccept()}},drawBox:function(e,t,n,i,a){a="undefined"==typeof a?0:a,imgPrintSet=screen.printBox.imgPrintSet,s=screen.printBox.printSet,0==a&&screen.printBox.drawElement(s.background,e,t,n,i,imgPrintSet),screen.printBox.drawElement(s.topLeftBox,e,t,s.topLeftBox.sizex,s.topLeftBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.TopBox,e+s.topLeftBox.sizex,t,n-s.topLeftBox.sizex-s.topRightBox.sizex,s.TopBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.topRightBox,e+n-s.topRightBox.sizex,t,s.topRightBox.sizex,s.topRightBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.LeftBox,e,t+s.topLeftBox.sizey,s.LeftBox.sizex,i-s.topLeftBox.sizey-s.bottomLeftBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.RightBox,e+n-s.topRightBox.sizex,t+s.topRightBox.sizey,s.RightBox.sizex,i-s.topRightBox.sizey-s.bottomRightBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.bottomLeftBox,e,t+i-s.bottomLeftBox.sizey,s.bottomLeftBox.sizex,s.bottomLeftBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.BottomBox,e+s.bottomLeftBox.sizex,t+i-s.bottomRightBox.sizey,n-s.bottomLeftBox.sizex-s.bottomRightBox.sizex,s.BottomBox.sizey,imgPrintSet,a),screen.printBox.drawElement(s.bottomRightBox,e+n-s.bottomRightBox.sizex,t+i-s.bottomRightBox.sizey,s.bottomRightBox.sizex,s.bottomRightBox.sizey,imgPrintSet,a)}},screen.effectPixelize2=function(e){for(var t=this.ctx.getImageData(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT),n=t.data,i=0;i<this.GHEIGHT;i+=e)for(var s=0;s<this.GWIDTH;s+=e)for(var a=n[4*(this.GWIDTH*i+s)],r=n[4*(this.GWIDTH*i+s)+1],o=n[4*(this.GWIDTH*i+s)+2],c=0;e>c;c++)for(var l=0;e>l;l++)s+l<this.GWIDTH&&(n[4*(this.GWIDTH*(i+c)+(s+l))]=a,n[4*(this.GWIDTH*(i+c)+(s+l))+1]=r,n[4*(this.GWIDTH*(i+c)+(s+l))+2]=o);this.ctx.putImageData(t,0,0)},screen.effectPixelize=function(e){this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT,this.GSTARTX,this.GSTARTY,e,e),this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,e,e,this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT)},screen.effectTension1=function(e){this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,Math.floor(this.GWIDTH/2),this.GHEIGHT,Math.floor(this.GSTARTX-this.GWIDTH*e/128/2),this.GSTARTY,Math.floor(this.GWIDTH/4),this.GHEIGHT),this.ctx.drawImage(this.canvas,this.GSTARTX+this.GWIDTH/2,this.GSTARTY,Math.floor(this.GWIDTH/2),this.GHEIGHT,Math.floor(this.GSTARTX+this.GWIDTH/2+this.GWIDTH*e/128/2),this.GSTARTY,Math.floor(this.GWIDTH/4),this.GHEIGHT),this.ctx.fillStyle="#000000",this.ctx.fillRect(Math.floor(this.GSTARTX+this.GWIDTH/2-this.GWIDTH*e/128/2),this.GSTARTY,Math.floor(this.GWIDTH*e/128),this.GHEIGHT)},screen.effectColor=function(e,t){this.ctx.save(),this.ctx.fillStyle=t,this.ctx.globalAlpha=e,this.ctx.fillRect(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT),this.ctx.restore()},screen.shakeEffect=function(){this.shaking&&(this.shakes>0?(this.shakes--,"h"==this.shaking?this.GSTARTX=Math.floor(16*Math.sin(3*this.shakes/4)*this.shakes/16)+this.ORIGINALGSTARTX:this.GSTARTY=Math.floor(16*Math.sin(3*this.shakes/4)*this.shakes/16)+this.ORIGINALGSTARTY):0==this.shakes&&(this.shakes--,this.GSTARTX=this.ORIGINALGSTARTX,this.GSTARTY=this.ORIGINALGSTARTY,this.shaking=!1))},screen.shakeScreen=function(e){e="undefined"==typeof e?"h":e,this.shakes="undefined"==typeof this.shakes?0:this.shakes,this.shakes+=16,this.shaking="h"==e?"h":"v"},screen.effects={selected:null,startFrame:0,endFrame:0,intensity:[8,16,24,32,48,64,128],keepAfter:!1,fadeIn:function(e){var t=e[0],n=e[1];screen.effects.startFrame=screen.frameCount,screen.effects.endFrame=screen.effects.intensity.length,screen.effects.selected=t,screen.effects.keepAfter="keepEffect"==n?!0:!1},fadeOut:function(e){var t=e[0],n=e[1];screen.effects.startFrame=screen.frameCount,screen.effects.endFrame=screen.effects.intensity.length,screen.effects.selected=t,screen.effects.keepAfter="keepEffect"==n?!0:!1},noEffect:function(){screen.effects.selected=null}},screen.drawEffects=function(){if(null!=screen.effects.selected){if("pixelizeFadeIn"==screen.effects.selected){var e=screen.frameCount-screen.effects.startFrame;e>=screen.effects.endFrame&&(e=screen.effects.endFrame-1,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectPixelize(screen.effects.intensity[e])}if("pixelizeFadeOut"==screen.effects.selected){var e=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;0>=e&&(e=0,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectPixelize(screen.effects.intensity[e])}if("blackFadeOut"==screen.effects.selected){var e=screen.frameCount-screen.effects.startFrame;e>=screen.effects.endFrame&&(e=screen.effects.endFrame-1,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectColor(screen.effects.intensity[e]/128,"#000000")}if("blackFadeIn"==screen.effects.selected){var e=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;0>=e&&(e=0,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectColor(screen.effects.intensity[e]/128,"#000000")}if("whiteFadeOut"==screen.effects.selected){var e=screen.frameCount-screen.effects.startFrame;e>=screen.effects.endFrame&&(e=screen.effects.endFrame-1,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectColor(screen.effects.intensity[e]/128,"#FFFFFF")}if("whiteFadeIn"==screen.effects.selected){var e=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;0>=e&&(e=0,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectColor(screen.effects.intensity[e]/128,"#FFFFFF")}if("tension1"==screen.effects.selected){var e=screen.frameCount-screen.effects.startFrame-1;e>=screen.effects.endFrame&&(e=screen.effects.endFrame-1,screen.effects.keepAfter||screen.effects.noEffect()),screen.effectTension1(screen.effects.intensity[e])}}},camera.drawChars=function(){chars.sort(compareChars);for(var e=chars.length,t=0;e>t;t++){var n=chars[t];camera.drawChar(n)}},screen.drawMonsters=function(){for(var e=0;e<battle.monster.length;e++)screen.drawMonster(battle.monster[e],[Math.floor((e+1)*screen.GWIDTH/(battle.monster.length+1)-64),Math.floor(screen.GHEIGHT/3)])},screen.drawMenu=function(e){{var t=e.itemsLength;e.maxItemStringSize()}screen.printBox.drawBox(e.drawx,e.drawy,e.width,e.height);for(var n=0;t>n;n+=1){if(e.items[Object.keys(e.items)[n]].selected&&(e.wait?screen.printBox.drawBox(e.drawx+8,e.drawy+8+32*n,e.width-16,32,1):screen.printBox.drawBox(e.drawx+8,e.drawy+8+32*n,e.width-16,32,1+Math.floor(screen.frameCount/4)%2),"undefined"!=typeof e.items[Object.keys(e.items)[n]].icon)){var i=screen.printBox.imgPrintSet,s=screen.printBox.printSet,a=s[e.items[Object.keys(e.items)[n]].icon];screen.printBox.drawBox(e.drawx+e.width,e.drawy,a.sizex+16,a.sizey+16),screen.printBox.drawElement(a,e.drawx+e.width+8,e.drawy+8,a.sizex,a.sizey,i)}screen.ctx.fillText(Object.keys(e.items)[n],screen.GSTARTX+e.drawx+16,screen.GSTARTY+e.drawy+e.items[Object.keys(e.items)[n]].itemy)}},screen.drawStatus=function(e){var t=screen.GWIDTH-32-96,n=screen.GHEIGHT-16,i=screen.GSTARTX+16+96+8,s=screen.GSTARTY+8;screen.printBox.drawBox(i,s,t,n),screen.printBox.drawBox(i,s,t,n,0);for(var a=["name","st","dx","iq","level","xp"],r=0;r<a.length;r++){var o=a[r],c=e[o];"name"!=o?screen.ctx.fillText(o+": "+c,i+16,s+32*(1+r)):screen.ctx.fillText(c,i+16,s+32*(1+r))}screen.ctx.fillText("xp to next level: "+e.xpnextlevel,i+16,s+32*(1+r)),screen.ctx.fillText("hp: "+e.hp+"/"+e.hpmax,i+144,s+32*r),screen.drawFace(resources.faceset,e.face,[i+144,s+16]),screen.printBox.drawButtonAccept()},screen.showpicture=function(){if(screen.pictureStack.length>0)for(var e=0;e<screen.pictureStack.length;e+=1)screen.drawImage(resources.pictures[screen.pictureStack[e].image],screen.pictureStack[e].position)},screen.clearPicture=function(){for(var e in screen.pictureStack)delete screen.pictureStack[e];screen.pictureStack.length=0},screen.loop=function(){try{if(screen.frameCount+=1,screen.clearAll(),!screen.paused){engine.update(screen.frameCount),screen.shakeEffect(),"map"==engine.state?(camera.setupMap(engine.currentLevel),debug.showLayer.layer1&&camera.drawMapLayer(engine.currentLevel,"layer1"),debug.showLayer.layer2&&camera.drawMapLayer(engine.currentLevel,"layer2"),debug.showLayer.layer3&&camera.drawChars(),debug.showLayer.layer4&&camera.drawMapLayer(engine.currentLevel,"layer4")):"startScreen"==engine.state||"battle"==engine.state&&(dist.test(dist.efnumb[0]),screen.drawMonsters()),screen.showpicture(),screen.drawEffects(),screen.drawHID();for(var e in menus.allMenus)menus.allMenus[e].enabled&&screen.drawMenu(menus.allMenus[e]);battle.herotoshowstatus&&screen.drawStatus(battle.herotoshowstatus),screen.printBox.drawBoxAnimation(),printer.update()}debug.FPS.draw(),screen.requestAnimationFrame.call(window,screen.loop)}catch(t){alert("screen loop error: "+t)}},debug={},debug.showLayer={layer1:!0,layer2:!0,layer3:!0,layer4:!0},debug.FPS={counter:0,FPS:0,show:!1,draw:function(){this.counter+=1,this.show&&screen.ctx.fillText(this.FPS.toString()+" fps",screen.GSTARTX+2,screen.GSTARTY+16)},loop:function(){this.FPS=this.counter,this.counter=0,this.timer=setTimeout("debug.FPS.loop()",1e3)}};var HID={scale:1,bsz:96,offset:416,axeNotNull:.4,inputs:{up:{letter:"W",active:!1,mapX:96,mapY:0,color:"#111111",gamepad:function(e){return e.axes[1]<-HID.axeNotNull}},left:{letter:"A",active:!1,mapX:0,mapY:96,color:"#111111",gamepad:function(e){return e.axes[0]<-HID.axeNotNull}},down:{letter:"S",active:!1,mapX:96,mapY:192,color:"#111111",gamepad:function(e){return e.axes[1]>HID.axeNotNull}},right:{letter:"D",active:!1,mapX:192,mapY:96,color:"#111111",gamepad:function(e){return e.axes[0]>HID.axeNotNull}},accept:{letter:"I",active:!1,mapX:304,mapY:32,color:"#127826",gamepad:function(e){return e.buttons[0].pressed}},cancel:{letter:"J",active:!1,mapX:304,mapY:160,color:"#ed1c24",gamepad:function(e){return e.buttons[1].pressed}}},debugKeys:{resize:{letter:"0",toggle:function(){screen.resize()}},layer1:{letter:"1",toggle:function(){debug.showLayer.layer1=!debug.showLayer.layer1}},layer2:{letter:"2",toggle:function(){debug.showLayer.layer2=!debug.showLayer.layer2}},layer3:{letter:"3",toggle:function(){debug.showLayer.layer3=!debug.showLayer.layer3}},layer4:{letter:"4",toggle:function(){debug.showLayer.layer4=!debug.showLayer.layer4}}},processGamepad:function(){if("undefined"!=typeof HID.gamepads)for(var e=0;e<HID.gamepads.length;++e){var t=HID.gamepads[e];for(var n in HID.inputs){var i=HID.inputs[n];i.active=i.gamepad(t)?!0:!1}}},clearInputs:function(){for(var e in HID.inputs){var t=HID.inputs[e];t.release=!1}},cleanInputs:function(){for(var e in HID.inputs){var t=HID.inputs[e];t.active=!1}},log:function(e){var t=document.getElementById("log");t.innerHTML=e},keyDown:function(e){var t=window.event?event:e,n=t.charCode?t.charCode:t.keyCode,i=String.fromCharCode(n);for(var s in HID.inputs){var a=HID.inputs[s];i==a.letter&&(a.active=!0)}},keyUp:function(e){var t=window.event?event:e,n=t.charCode?t.charCode:t.keyCode,i=String.fromCharCode(n);for(var s in HID.inputs){var a=HID.inputs[s];i==a.letter&&(a.active=!1)}for(var s in HID.debugKeys){var a=HID.debugKeys[s];i==a.letter&&a.toggle()}},setupTouchZone:function(e){this.screen=e,this.touchzone=this.screen.canvas},setupKeyboardListeners:function(){document.onkeydown=HID.keyDown,document.onkeyup=HID.keyUp},handleTouchDown:function(e){e.preventDefault(),HID.processTouches(event.touches,"down")},handleTouchMove:function(e){e.preventDefault(),HID.processTouches(event.touches,"move")},handleTouchUp:function(e){e.preventDefault(),HID.processTouches(event.touches,"up")},processTouches:function(e,t){for(var n in HID.inputs){var i=HID.inputs[n],s=!1,a=this.screen.canvas.offsetTop,r=this.screen.canvas.offsetLeft;scale=this.screen.currentWidth/this.screen.WIDTH;for(var o=0;o<e.length;o++){var c={x:(e[o].pageX-r)/scale,y:(e[o].pageY-a)/scale};c.x>i.mapX&&c.y>this.offset+i.mapY&&c.x<i.mapX+this.bsz&&c.y<this.offset+i.mapY+this.bsz&&(s=!0)}s?(i.active=!0,"down"==t&&(i.release=!0)):i.active=!1}for(var l in menus.allMenus){var h=menus.allMenus[l];if(h.enabled&&!h.wait){var u=h.itemsLength;for(var f in h.items){var d=h.items[f],s=!1,a=this.screen.canvas.offsetTop,r=this.screen.canvas.offsetLeft;scale=this.screen.currentWidth/this.screen.WIDTH;for(var o=0;o<e.length;o++){var c={x:(e[o].pageX-r)/scale,y:(e[o].pageY-a)/scale};c.x>screen.GSTARTX+h.drawx&&c.y>screen.GSTARTY+h.drawy+d.itemy-32&&c.x<screen.GSTARTX+h.drawx+h.width&&c.y<screen.GSTARTY+h.drawy+d.itemy&&(s=!0)}if(s){if("down"==t&&d.selected)return void(HID.inputs.accept.active=!0);for(var p=0;u>p;p+=1)h.items[Object.keys(h.items)[p]].selected=!1;d.selected=!0,h.selectedItem=d}}}}},setupListeners:function(){window.addEventListener("touchstart",HID.handleTouchDown,!1),window.addEventListener("touchmove",HID.handleTouchMove,!1),window.addEventListener("touchend",HID.handleTouchUp,!1),window.addEventListener("gamepadconnected",function(){HID.gamepads=navigator.getGamepads()}),window.addEventListener("gamepaddisconnected",function(){HID.gamepads=[],HID.cleanInputs(),HID.clearInputs()})},setup:function(e){this.setupTouchZone(e),this.setupListeners(),this.setupKeyboardListeners()}},printer={};printer.currentText=null,printer.dialogLines=null,printer.currentLine=0,printer.isShown=!1,printer.textLines=function(e){var t=wordWrap(e,31),n=t.split("\n").filter(Boolean).length;return n},printer.showText=function(e){printer.currentText=wordWrap(e,31),printer.currentLine=0,printer.isShown=!0,printer.dialogLines=printer.currentText.split("\n").filter(Boolean),printBox.show(),printer.LineWords=[],printer.dialogLines.length-printer.currentLine<1?(printer.wordIndexLine=[],printer.LineWords=null):printer.dialogLines.length-printer.currentLine<2?(printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" ")),printer.wordIndexLine=[0]):(printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" ")),printer.LineWords.push(printer.dialogLines[printer.currentLine+1].split(" ")),printer.wordIndexLine=[0,0]),printer.Line=["",""],printer.LineLine=0},printer.dismissText=function(){printer.currentText=null,printer.currentLine=0,printer.isShown=!1,printer.dialogLines=null,printBox.close(),printer.LineWords=[],printer.wordIndexLine=[],printer.Line=["",""],printer.LineLine=0},printer.nextLine=function(){return printer.LineWords=[],printer.currentLine+=2,printer.currentLine>=printer.dialogLines.length?void printer.dismissText():(printer.LineWords=[],printer.dialogLines.length-printer.currentLine<1?(printer.wordIndexLine=[],printer.LineWords=null):printer.dialogLines.length-printer.currentLine<2?(printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" ")),printer.wordIndexLine=[0]):(printer.LineWords.push(printer.dialogLines[printer.currentLine].split(" ")),printer.LineWords.push(printer.dialogLines[printer.currentLine+1].split(" ")),printer.wordIndexLine=[0,0]),printer.Line=["",""],void(printer.LineLine=0))},printer.update=function(){var e=0,t=0;if(printer.currentText&&printer.dialogLines.length&&printBox.isShown())for(screen.ctx.fillStyle="#FFFFFF",Math.floor(screen.frameCount/4)%2&&this.LineLine<printer.wordIndexLine.length&&null!=printer.LineWords&&(feedbackEng.play("word"),printer.wordIndexLine[this.LineLine]<printer.LineWords[this.LineLine].length?(printer.Line[this.LineLine]+=printer.LineWords[this.LineLine][printer.wordIndexLine[this.LineLine]]+" ",printer.wordIndexLine[this.LineLine]+=1):this.LineLine+=1),e=printer.currentLine,t=0;e<printer.dialogLines.length&&2>t;e+=1,t+=1)screen.ctx.fillText(printer.Line[e%2],screen.GSTARTX+screen.printBox.X+16,screen.GSTARTY+screen.printBox.Y+40+34*t)};var title={};title.setup=function(){title.startMenu=new menu({start:{action:[function(){actions.showText("let's play!"),actions.fadeOut("blackFadeOut;keepEffect"),actions.changeState("map")},function(){actions.stopPicture("")},function(){actions.fadeIn("blackFadeIn;doNotKeep")},"exit"],index:0},exit:{action:"exit",index:1}},void 0,!0),menus.setParent(title.startMenu),title.startMenu.activate(),actions.showPicture("title;0;0"),setTimeout(function(){"startScreen"==engine.state&&engine.showPicture(["keys0","160","8"])},1e3),setTimeout(function(){"startScreen"==engine.state&&engine.showPicture(["keys2","160","24"])},4e3),setTimeout(function(){"startScreen"==engine.state&&(engine.stopPicture(""),engine.showPicture(["title","0","0"]),engine.showPicture(["keys1","150","16"]))},1e4)},title.startScreen=function(){title.update()},title.update=function(){printer.isShown||0==player.steps&&HID.inputs.cancel.active&&(HID.inputs.cancel.active=!1,title.startMenu.activate())};var dist={};dist.setup=function(e,t,n){dist.alpha=n,dist.tickssy=0,dist.bfx={},dist.efnumb=[],dist.efnumb[0]=1,dist.bfx.effectsrom=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[120,0,4,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,1,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,2,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,3,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[255,0,3,0,2,0,0,0,0,0,0,0,0,1,0,0,0],[255,0,3,0,2,0,255,0,0,0,0,0,0,255,0,0,0],[255,0,1,0,2,0,0,0,0,0,0,0,0,1,0,0,0],[255,0,1,0,2,0,255,0,0,0,0,0,0,255,0,0,0],[0,0,3,0,2,0,128,0,0,2,0,0,0,0,0,0,0],[0,0,3,0,2,0,128,0,128,0,0,0,0,0,0,0,0],[0,1,3,0,4,0,64,0,0,1,0,0,0,0,0,2,0],[0,1,3,0,4,0,64,0,0,3,0,0,0,0,0,254,255],[0,4,1,0,8,0,64,128,0,0,254,255,0,0,1,0,0],[0,4,1,0,0,0,64,128,0,0,2,0,0,0,255,0,0],[88,2,3,0,0,0,0,0,0,1,0,0,0,0,0,3,0],[88,2,3,0,0,0,0,0,8,8,0,0,0,0,0,253,255],[0,2,3,0,0,0,0,0,0,2,0,0,0,0,0,255,255],[0,2,3,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[240,0,3,0,0,0,0,0,224,2,0,0,0,0,0,254,255],[240,0,3,0,0,0,0,0,0,0,0,0,0,0,0,2,0],[240,0,1,0,4,0,128,1,0,0,254,255,156,255,1,0,0],[240,0,1,32,2,64,34,241,0,0,2,0,100,0,255,0,0],[0,1,4,0,2,0,64,2,0,1,2,0,0,0,1,2,0],[0,1,4,0,4,0,64,2,0,3,254,255,0,0,255,254,255],[0,0,1,128,0,0,8,1,0,0,0,0,0,0,0,0,0],[0,1,1,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,1,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[244,1,1,0,2,0,0,2,0,0,0,0,128,0,0,0,0],[244,1,1,0,2,0,250,2,0,0,0,0,128,255,0,0,0],[244,1,1,0,2,0,0,10,0,0,0,0,80,0,0,0,0],[244,1,1,0,2,64,156,10,0,0,0,0,176,255,0,0,0],[240,0,3,0,2,0,8,2,0,0,0,0,0,0,0,1,0],[224,1,3,0,2,0,8,2,0,240,0,0,0,0,0,254,255],[240,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[180,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[104,1,1,0,1,0,0,2,0,0,0,0,128,0,0,0,0],[104,1,1,0,1,0,0,2,0,0,0,0,64,0,0,0,0],[0,0,2,0,16,128,250,10,0,0,0,0,0,0,0,0,0],[224,1,2,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[240,0,1,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,224,0,0,16,0,0,0,0,0,0,0,2,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,3,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[224,1,3,0,2,0,4,2,0,1,0,0,0,0,0,2,0],[224,1,3,0,2,0,4,2,192,4,0,0,0,0,0,254,255],[0,0,3,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,3,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,150,0,0,0,0],[0,1,3,0,4,0,150,2,0,0,0,0,106,255,0,0,0],[104,1,4,0,1,0,0,0,0,0,0,0,60,0,2,0,0],[104,1,4,0,1,96,84,0,0,0,0,0,196,255,2,0,0],[0,0,3,0,1,0,4,0,0,0,0,0,0,0,2,0,0],[240,0,4,0,1,0,0,0,0,0,0,0,90,0,2,0,0],[240,0,4,0,1,96,84,0,0,0,0,0,166,255,2,0,0],[254,1,3,0,2,0,0,0,0,0,0,0,128,0,0,0,0],[254,1,3,0,2,0,255,0,0,0,0,0,128,255,0,0,0]],dist.bfx.w=256,dist.bfx.h=240,dist.buffer=document.createElement("canvas"),dist.buffer.width=dist.bfx.w,dist.buffer.height=dist.bfx.h,dist.bufferwidth=dist.buffer.width,dist.bufferheight=dist.buffer.height,dist.bctx=dist.buffer.getContext("2d"),dist.bgimage=document.getElementById(t),dist.bctx.drawImage(dist.bgimage,0,0,416,416,0,0,dist.bfx.w,dist.bfx.h),dist.bufferData=dist.bctx.getImageData(0,0,dist.bfx.w,dist.bfx.h),dist.bdata=dist.bufferData.data,dist.bctx.mozImageSmoothingEnabled=!1,dist.bctx.webkitImageSmoothingEnabled=!1,dist.bctx.imageSmoothingEnabled=!1,dist.visible=e,dist.fctx=dist.visible.getContext("2d"),dist.fctx.mozImageSmoothingEnabled=!1,dist.fctx.webkitImageSmoothingEnabled=!1,dist.fctx.imageSmoothingEnabled=!1,dist.bfx.getType=function(){return dist.bfx.effect[2]},dist.bfx.getDuration=function(){return dist.bfx.effect[0]+(dist.bfx.effect[1]<<8)},dist.bfx.getFrequency=function(){return dist.bfx.effect[3]+(dist.bfx.effect[4]<<8)},dist.bfx.getAmplitude=function(){return dist.bfx.effect[5]+(dist.bfx.effect[6]<<8)},dist.bfx.getCompression=function(){return dist.bfx.effect[8]+(dist.bfx.effect[9]<<8)},dist.bfx.getFrequencyAcceleration=function(){return dist.bfx.effect[10]+(dist.bfx.effect[11]<<8)},dist.bfx.getAmplitudeAcceleration=function(){return dist.bfx.effect[12]+(dist.bfx.effect[13]<<8)},dist.bfx.getSpeed=function(){return dist.bfx.effect[14]},dist.bfx.getCompressionAcceleration=function(){return dist.bfx.effect[15]+(dist.bfx.effect[16]<<8)},dist.Distorter=function(e,t,n,i,s,a,r,o,c,l){var h=(1/512).toFixed(6),u=(8*Math.PI/262144).toFixed(6),f=(Math.PI/60).toFixed(6),d=i+s*t*2,p=a+r*t*2,m=o+c*t*2,g=Math.round(h*d*Math.sin((u*p*e+f*l*t).toFixed(6)));if(1==n)return g;if(2==n)return e%2==0?-g:g;if(3==n){var x=Math.floor(e*(1+m/256)+g)%256;return 0>x&&(x=256+x),x>255&&(x=256-x),x}return 0},dist.ComputeFrame=function(e,t,n,i,s,a,r,o,c,l,h,u,f,d){var p=e,m=t,g=1024,x=1024,v=0,b=0;for(b=0;224>b;b++)for(S=dist.Distorter(b,s,n,o,c,l,h,u,f,d),L=b,3==n&&(L=S),v=0;256>v;v++){var y=4*v+b*g;if(i>b||b>224-i)p[y+2]=0,p[y+1]=0,p[y+0]=0;else{var w=v;(1==n||2==n)&&(w=(v+S)%256,0>w&&(w=256+w),w>255&&(w=256-w));var T=4*w+L*x;1==r?(p[y+3]=255,p[y+2]=a*m[T+2],p[y+1]=a*m[T+1],p[y+0]=a*m[T+0]):(p[y+3]=255,p[y+2]+=a*m[T+2],p[y+1]+=a*m[T+1],p[y+0]+=a*m[T+0])}}return p},dist.test=function(e){dist.tickssy+=1;var t=document.createElement("canvas");t.width=dist.bfx.w,t.height=dist.bfx.h;var n=t.getContext("2d"),i=n.getImageData(0,0,dist.bfx.w,dist.bfx.h),s=i.data;dist.bfx.effect=dist.bfx.effectsrom[e],dist.bfx.getDuration(),dist.ComputeFrame(s,dist.bdata,dist.bfx.getType(),0,dist.tickssy,dist.alpha,0,dist.bfx.getAmplitude(),dist.bfx.getAmplitudeAcceleration(),dist.bfx.getFrequency(),dist.bfx.getFrequencyAcceleration(),dist.bfx.getCompression(),dist.bfx.getCompressionAcceleration(),dist.bfx.getSpeed()),n.putImageData(i,0,0),dist.fctx.drawImage(t,0,0,dist.bfx.w,dist.bfx.h,screen.GSTARTX,screen.GSTARTY,screen.GWIDTH,screen.GHEIGHT+31)}},battle={},battle.atk={},battle.skl={},battle.action={},battle.effect={},battle.setup=function(){battle.maxlevel=99,battle.herotoshowstatus=!1,battle.order=new Array,battle.heroes=clone(resources.hms.Heroes);for(var e in battle.heroes)battle.initHero(battle.heroes[e])},battle.initHero=function(e){e.side="hero",e.xp=0,e.level=0,e.xpnextlevel=e.ExpToLevel[0]*e.level+e.ExpToLevel[1],e.skill=[],e.hp=0,e.hpmax=0,e.mod={st:0,dx:0,iq:0},e.equiped={weapon:!1,armor:!1},battle.uplevel(e,1,!0)},battle.initMonster=function(e){if(e.side="monster",e.level=0,e.skill=[],e.hp=0,e.hpmax=0,battle.setMonsterLevel(e),!("prob"in e)){var t={},n=0,i=clone(e.skill);i.push("atk");for(var s=0;s<i.length;s++)s==i.length-1?t[i[s]]=1-n:(n+=1/i.length,t[i[s]]=1/i.length);e.prob=t}e.xpreward=e.ExpToLevel[0]*e.level+e.ExpToLevel[1],e.dead=!1},battle.uplevel=function(e,t,n){var n="undefined"==typeof n?!1:n,i=e.level;if(t>i){e.st=Math.floor(t*e.baseStats.st/battle.maxlevel),e.dx=Math.floor(t*e.baseStats.dx/battle.maxlevel),e.iq=Math.floor(t*e.baseStats.iq/battle.maxlevel),e.hp=Math.floor(t*e.baseStats.hp/battle.maxlevel),e.hpmax=Math.floor(t*e.baseStats.hp/battle.maxlevel);for(var s=i+1;t+1>s;s++){var a=s.toString(),r=e.name+" reached level "+a+"!";if(e.level=s,e.xpnextlevel+=e.ExpToLevel[0]*e.level+e.ExpToLevel[1],a in e.Pathway){if("learn"in e.Pathway[a]){var o=e.Pathway[a].learn;for(var c in o)e[c].push(o[c]),r+="\n"+e.name+" learned "+o[c]+"!"}if("forget"in e.Pathway[a]){var l=e.Pathway[a].forget;for(var c in l)removeA(e[c],l[c]),r+="\n"+e.name+" forgot "+l[c]+"!"}}n||actions.showText(r)}}},battle.setMonsterLevel=function(e){for(var t=0,n=0;n<player.party.length;n++)t+=battle.hero[n].level;t=Math.floor(t/player.party.length),t+=battle.diceroll(1)+player.party.length,t=Math.max(t-3,1),battle.uplevel(e,t,!0)},battle.selectFromProb=function(e){var t=Math.random(),n=0;for(atsk in e){if(t>=n&&t<=n+e[atsk])return atsk;n+=e[atsk]}},battle.diceroll=function(e){for(var t=e,n=0;t>0;)t--,n+=Math.floor(3*Math.random()+1);return n},battle.action.atk=function(){actions.showText("attack!")},battle.action.skill=function(e){actions.showText(e)},battle.start=function(e){battle.holdAtomStack=engine.atomStack,engine.atomStack=new Array,battle.monster=[],battle.hero=[],battle.waitherodecision=!1,battle.bchToAttack=[],battle.ended=!1,battle.xpreward=0,e.length>1&&(dist.efnumb[0]=31);for(var t=0;t<player.party.length;t++)battle.hero[t]=battle.heroes[player.party[t]];for(var t=0;t<e.length;t++)battle.monster[t]=clone(resources.hms.Monsters[e[t]]),battle.initMonster(battle.monster[t]);battle.skills=resources.hms.Skills,battle.setOrderStack(),actions.fadeIn("blackFadeIn;doNotKeep")},battle.resolveOrder=function(){if(!battle.ended)if(battle.waitherodecision)battle.hAttack(battle.bchToAttack[0]);else if(battle.order.length>0)if(battle.bchToAttack=battle.order.shift(),"hero"==battle.bchToAttack[1]){if(console.log("hero attack"),battle.resolveIfSideDead())return;if(battle.herodecision="action",actions.questionBox("attack;skill"),battle.waitherodecision=!0,battle.resolveIfSideDead())return}else{if(console.log("monster attack"),battle.resolveIfSideDead())return;if(battle.bchToAttack[0].dead||battle.mAttack(battle.bchToAttack[0]),battle.resolveIfSideDead())return}else battle.isPartyAlive()&&battle.setOrderStack()},battle.resolveIfSideDead=function(){if(!battle.isPartyAlive()){for(;battle.order.length>0;)battle.order.pop();return battle.ended=!0,actions.showText("You died!"),battle.end("died"),!0
}if(!battle.isMonstersAlive()){for(;battle.order.length>0;)battle.order.pop();return battle.ended=!0,actions.showText("You win!"),battle.end("win"),!0}return!1},battle.setOrderStack=function(){for(;battle.order.length>0;)battle.order.pop();for(var e=0;e<player.party.length;e++)battle.order.push([battle.hero[e],"hero"]);for(var e=0;e<battle.monster.length;e++)battle.order.push([battle.monster[e],"monster"]);battle.order.sort(function(e,t){return e[0].dx>t[0].dx?-1:e[0].dx<t[0].dx?1:0})},battle.hAct={},battle.hAct.askTarget=function(){engine.questionBoxAnswer=engine.questionBoxUndef,battle.hAct.targetting=!0,battle.herodecision="target";for(var e=[],t=0;t<battle.monster.length;t++)battle.monster[t].dead||e.push(battle.monster[t]);if(1==e.length)return e[0].selected=!1,battle.hAct.targetting=!1,battle.hAct.__target=[e[0]],engine.questionBoxAnswer=0,void(HID.inputs.accept.active=!1);for(var t=0;t<e.length;t++)e[t].selected=!1,e[t].flash=0,0==t?(e[t].previous=e[0],e[t].next=e[t+1]):t==e.length-1?(e[t].previous=e[t-1],e[t].next=e[t]):(e[t].previous=e[t-1],e[t].next=e[t+1]);e[0].selected=!0,battle.hAct.selectedMonster=e[0]},battle.hAct.changeSelection=function(e){battle.hAct.selectedMonster.selected=!1,battle.hAct.selectedMonster=battle.hAct.selectedMonster[e],battle.hAct.selectedMonster.selected=!0},battle.hAct.targetUpdate=function(){"undefined"==typeof this.keyPressed&&(this.keyPressed=0),0==this.keyPressed?HID.inputs.up.active?(battle.hAct.changeSelection("previous"),HID.inputs.up.active=!1,this.keyPressed=32):HID.inputs.left.active?(battle.hAct.changeSelection("previous"),HID.inputs.left.active=!1,this.keyPressed=32):HID.inputs.right.active?(battle.hAct.changeSelection("next"),HID.inputs.right.active=!1,this.keyPressed=32):HID.inputs.down.active?(battle.hAct.changeSelection("next"),HID.inputs.down.active=!1,this.keyPressed=32):HID.inputs.accept.active?(this.selectedMonster.selected=!1,battle.hAct.targetting=!1,battle.hAct.__target=[battle.hAct.selectedMonster],engine.questionBoxAnswer=0,HID.inputs.accept.active=!1,this.keyPressed=32):HID.inputs.cancel.active:this.keyPressed-=4},battle.hAttack=function(e){if(engine.questionBoxAnswer!=engine.questionBoxUndef&&"action"==battle.herodecision)if(0==engine.questionBoxAnswer)if(battle.hAct.__damage=battle.atk.pts(e),battle.hAct.__actionType=["hpdown"],battle.hAct.__skill="atk",battle.monster.length<=1){battle.hAct.__target=[battle.monster[0]];var t=!0}else battle.hAct.askTarget();else if(1==engine.questionBoxAnswer){battle.herodecision="skill";var n=e.skill.join(";");n="back;"+n,actions.questionBox(n)}if(engine.questionBoxAnswer!=engine.questionBoxUndef&&"skill"==battle.herodecision)if(0==engine.questionBoxAnswer)battle.herodecision="action",actions.questionBox("attack;skill");else{actions.showText(engine.questionBoxAnswerStr),battle.hAct.__damage=battle.skl.pts(e,engine.questionBoxAnswerStr),battle.hAct.__actionType=battle.skills[engine.questionBoxAnswerStr].effect,battle.hAct.__target=[battle.monster[0]],battle.hAct.__skill=engine.questionBoxAnswerStr;var t=!0}if(engine.questionBoxAnswer!=engine.questionBoxUndef&&"target"==battle.herodecision)var t=!0;"undefined"!=typeof t&&0!=t&&(console.log("attacked"),battle.resolveAtk(e,battle.hAct.__target,battle.hAct.__damage,battle.hAct.__actionType,battle.hAct.__skill),actions.proceedBattleTurn())},battle.mAttack=function(e){var t=e,n=battle.selectFromProb(t.prob),i=0,s=[],a=[battle.mTarget(t)];"atk"==n?(i=battle.atk.pts(t),s=["hpdown"]):(i=battle.skl.pts(t,n),s=battle.skills[n].effect,"all"==battle.skills[n].affect&&(a=battle.hero)),i>0?screen.flashMonster(t,"#eeeeee"):screen.shakeMonster(t),battle.resolveAtk(t,a,i,s,n)},battle.resolveAtk=function(e,t,n,i,s){for(var a=0;a<t.length;a++)for(var r=0;r<i.length;r++)battle.effect[i[r]](e,t[a],n,s)},battle.effect.hpdown=function(e,t,n,i){t.hp=Math.max(t.hp-n,0),actions.showText("atk"==i?e.name+" attacked "+t.name+" and dealt "+n+" damage!":e.name+" used "+i+" on "+t.name+" and dealt "+n+" damage!"),"monster"==t.side&&screen.flashMonster(t,"#bf0010")},battle.effect.hpup=function(e,t,n){t.hp=Math.min(t.hp+n,t.hpmax)},battle.mTarget=function(e){var t=!0;if("splash"==e.target);else if("hero"==e.target){for(var n=battle.hero.length,i=0;n>i;i++)if(battle.hero[i].Leader&&battle.isAlive(battle.hero[i]))return battle.hero[i]}else if("weakest"==e.target){for(var s=999999999,a=0,i=0;n>i;i++)battle.hero[i].hp<s&&battle.hero[i].hp>0&&(s=battle.hero[i].hp,a=i);return battle.hero[a]}for(var r=0,n=battle.hero.length,o={},i=0;n>i;i++)o[i]=1/n;for(var c=0;t&&(c++,r=battle.selectFromProb(o),t=!battle.isAlive(battle.hero[r]),!(c>20)););return battle.hero[r]},battle.end=function(e){battle.lastresult=e;for(var t=0;t<battle.hero.length;t++)if(battle.isAlive(battle.hero[t])){var n=battle.hero[t];for(n.xp+=Math.floor(battle.xpreward/battle.hero.length);n.xp>n.xpnextlevel;){var i=n.level+1;battle.uplevel(n,i)}}actions.changeState("map"),engine.atomStack.push([function(){engine.atomStack=battle.holdAtomStack},""])},battle.isPartyAlive=function(){for(var e=0,t=0;t<battle.hero.length;t++)e+=battle.isAlive(battle.hero[t]);return e>0},battle.monsterDies=function(e){battle.xpreward+=e.xpreward},battle.isMonstersAlive=function(){for(var e=0,t=0;t<battle.monster.length;t++)e+=battle.isAlive(battle.monster[t]),battle.isAlive(battle.monster[t])||battle.monster[t].dead||(battle.monster[t].dead=!0,battle.monsterDies(battle.monster[t]));return e>0},battle.isAlive=function(e){return e.hp>0},battle.atk.pts=function(e){return battle.diceroll(e.st)},battle.skl.pts=function(e,t){var n=getkey0(battle.skills[t],"basep"),i=getkey0(battle.skills[t],"plus"),s=0;return"atr"in battle.skills[t]&&(s=e[battle.skills[t].atr]),Math.max(battle.diceroll(n+s)+i,0)},battle.mApplyState=function(e,t){for(var n in e.state[t])e[n]=e.state[t][n]},battle.update=function(){battle.resolveOrder(),battle.hAct.targetting&&battle.hAct.targetUpdate()};var bootstrap={},descriptors="descriptors/",charaset="charaset/",levelsFolder="levels/",charasetsFolder="charaset/",charasFolder="charas/",resources={tileset:null,playerChara:null,printerset:null,playerCharaset:null,faceset:null,items:{},levels:{},charasets:{},charas:{},hms:{}};window.forceMobile=!1;for(var query=window.location.search.substring(1).split("&"),i=0,max=query.length;max>i;i++)if(""!==query[i]){var param=query[i].split("=");"forceMobile"!=param[0]||"true"!=param[1]&&"True"!=param[1]&&"1"!=param[1]||(window.forceMobile=!0),"debug"!=param[0]||"true"!=param[1]&&"True"!=param[1]&&"1"!=param[1]||window.addEventListener("unload",function(e){e.preventDefault(),jsonLevelGet("http://127.0.0.1:8081/exit.json")},!1)}resources.harvest=function(){this.tileset=document.getElementById("tile"),this.faceset=document.getElementById("faceset"),this.charasetimg=document.getElementById("charasetimg"),this.printerset=document.getElementById("printerimg"),this.monsterimg=document.getElementById("monsterbattleimg"),this.pictures={},this.pictures.title=document.getElementById("titleimg"),this.pictures.keys0=document.getElementById("keys0"),this.pictures.keys1=document.getElementById("keys1"),this.pictures.keys2=document.getElementById("keys2"),LevelsList=init.LevelsList;for(var e in LevelsList){var t=LevelsList[e];console.log(descriptors+levelsFolder+t),resources.levels[e]=jsonLevelGet(descriptors+levelsFolder+t)}CharasetFileList=init.CharasetFileList;for(var n in CharasetFileList){var i=CharasetFileList[n];console.log(descriptors+charasetsFolder+i),resources.charasets=jsonLevelGet(descriptors+charasetsFolder+i).Charaset}resources.charas=jsonLevelGet(descriptors+"charas.json").Charas,this.playerCharaset=resources.charasets[init.Player.charaSet],this.hms=jsonLevelGet(descriptors+init.HMSFile),this.items=jsonLevelGet(descriptors+init.itemsFile).Items};var init=jsonLevelGet(descriptors+"init.json");bootstrap.onLoadDOM=function(){try{var e=document.getElementById("loading");e.parentNode.removeChild(e),document.ontouchmove=function(e){e.preventDefault()},document.getElementsByTagName("canvas")[0].getContext("2d").fillText("LOADING...",64,64),resources.harvest(),screen.init(),player.setup(),camera.setupCanvas(screen.canvas),engine.setup(),screen.setEngine(engine),HID.setup(screen),engine.currentLevel=resources.levels[init.World.initLevel],screen.printBox.setup(resources.printerset),feedbackEng.setup(),title.setup(),battle.setup(),menus.setAllDrawables(),engine.loop(),screen.requestAnimationFrame.call(window,function(){screen.loop()}),debug.FPS.loop(),chars=new charalist,chars.push(player)}catch(t){alert("Error on bootstrap! "+t)}};